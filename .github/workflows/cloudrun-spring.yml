name: Build, Test and Deploy to Cloud Run

on:
  push:
    branches: ["main"]      # change if your default branch is different (e.g. "master")

permissions:
  contents: read
  id-token: write

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Set up Java 17 and cache Maven deps
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # 3) Build & test with Maven
      - name: Build and test
        run: mvn -B verify

      # 4) Authenticate to Google Cloud (uses your JSON key secret)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
          project_id: '${{ secrets.GCP_PROJECT_ID }}'

      # 5) Deploy to Cloud Run from source (Cloud Build will use your Dockerfile)
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'
          region: '${{ secrets.GCP_REGION }}'
          service: '${{ secrets.CLOUD_RUN_SERVICE }}'
          source: '.'          # Build container image from source + Dockerfile in GCP

      # 6) Show the deployed URL in logs
      - name: Show URL
        run: 'echo "Service URL: ${{ steps.deploy.outputs.url }}"'