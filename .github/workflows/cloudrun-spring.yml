name: Build, Test and Deploy to Cloud Run (Docker Image)

on:
  push:
    branches: ["main"]      # change if your default branch is different

permissions:
  contents: read
  id-token: write

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Set up Java 17 and cache Maven deps
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # 3) Build & test with Maven
      - name: Build and test
        run: mvn -B verify

      # 4) Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      # 5) Install gcloud CLI (needed for docker auth)
      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'

      # 6) Configure Docker to use gcloud as a credential helper for Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      # 7) Build Docker image (using your Dockerfile)
      - name: Build Docker image
        run: |
          docker build \
            -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/github-actions-demo:${{ github.sha }} \
            .

      # 8) Push Docker image to Artifact Registry
      - name: Push Docker image
        run: |
          docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/github-actions-demo:${{ github.sha }}

      # 9) Deploy to Cloud Run using the pushed image
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'
          region: '${{ secrets.GCP_REGION }}'
          service: '${{ secrets.CLOUD_RUN_SERVICE }}'
          image: '${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/github-actions-demo:${{ github.sha }}'

      # 10) Show the deployed URL
      - name: Show URL
        run: 'echo "Service URL: ${{ steps.deploy.outputs.url }}"'
